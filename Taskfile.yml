version: '3'

tasks:
  docker_prod:
    desc: "Docker build and run."
    aliases:
      - prod
    cmds:
      - task: create_logs_folder
      - task: create_migrations_folders
      - task: docker_build
      - task: docker_run
      - task: copy_sso_migrations
      - task: migrate_sso
      - task: copy_toys_migrations
      - task: migrate_toys

  create_logs_folder:
    desc: "Create logs folder for docker volume purposes."
    internal: true
    cmds:
      - mkdir -p logs/hmtm_bff
      - mkdir -p logs/hmtm_sso

  create_migrations_folders:
    desc: "Create migrations folders for docker volume purposes."
    internal: true
    cmds:
      - mkdir -p migrations/hmtm_sso

  copy_sso_migrations:
    desc: "
    Copy SSO service migrations from docker volume.
    https://stackoverflow.com/questions/32566624/docker-cp-all-files-from-a-folder-to-existing-container-folder 
    https://docs.docker.com/reference/cli/docker/container/cp/
    "
    internal: true
    cmd: sudo docker cp hmtm_sso:/app/migrations/. ./migrations/hmtm_sso

  copy_toys_migrations:
    desc: "Copy Toys service migrations from docker volume."
    internal: true
    cmd: sudo docker cp hmtm_toys:/app/migrations/. ./migrations/hmtm_toys

  docker_build:
    desc: "Build docker container."
    cmd: sudo docker compose build

  docker_run:
    desc: "Launch docker container."
    cmd: sudo docker compose up -d

  docker_stop:
    desc: "Stop all docker containers."
    cmd:  sudo docker stop $(sudo docker ps -a -q)

  docker_clean:
    desc: "Clean docker containers, images and volumes."
    cmd: sudo docker system prune -a --volumes

  migrate_sso:
    desc: "Apply all available migrations for SSO service."
    internal: true
    vars:
      DIR: ./migrations/hmtm_sso
      DRIVER: postgres
      DATABASE_URL: "postgresql://hmtm_sso:hmtm_sso@0.0.0.0:15432/hmtm_sso"
    cmds:
      - go install github.com/pressly/goose/v3/cmd/goose@latest
      - goose -dir {{.DIR}} {{.DRIVER}} {{.DATABASE_URL}} up

  migrate_toys:
    desc: "Apply all available migrations for Toys service."
    internal: true
    vars:
      DIR: ./migrations/hmtm_toys
      DRIVER: postgres
      DATABASE_URL: "postgresql://hmtm_toys:hmtm_toys@0.0.0.0:25432/hmtm_toys"
    cmds:
      - go install github.com/pressly/goose/v3/cmd/goose@latest
      - goose -dir {{.DIR}} {{.DRIVER}} {{.DATABASE_URL}} up

  clean_up:
    desc: "Clean up all folders, docker volumes, images and containers."
    cmds:
      - task: docker_stop
      - sudo rm -rf logs/
      - sudo rm -rf migrations/
      - sudo rm -rf postgres_data/
      - sudo rm -rf postgres_backups/
      - task: docker_clean
